name: Deploy to Azure VM

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch: # Allow manual deployment

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Run tests
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint || echo "Linting completed"
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          DATA_GOV_API_KEY: ${{ secrets.DATA_GOV_API_KEY }}
      
      - name: Check build output
        run: |
          if [ -d ".next" ]; then
            echo "âœ… Build successful"
          else
            echo "âŒ Build failed"
            exit 1
          fi

  # Job 2: Deploy to Azure VM
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_SSH_PRIVATE_KEY }}" > ~/.ssh/azure_key
          chmod 600 ~/.ssh/azure_key
          ssh-keyscan -H ${{ secrets.AZURE_VM_IP }} >> ~/.ssh/known_hosts
      
      - name: Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            --exclude=node_modules \
            --exclude=.next \
            --exclude=.git \
            --exclude=postgres_data \
            --exclude=.env \
            --exclude=.env.local \
            .
      
      - name: Upload to Azure VM
        run: |
          scp -i ~/.ssh/azure_key deploy.tar.gz ${{ secrets.AZURE_SSH_USER }}@${{ secrets.AZURE_VM_IP }}:/tmp/
      
      - name: Deploy on Azure VM
        run: |
          ssh -i ~/.ssh/azure_key ${{ secrets.AZURE_SSH_USER }}@${{ secrets.AZURE_VM_IP }} << 'EOF'
            set -e
            
            # Colors for output
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m'
            
            echo -e "${GREEN}ðŸš€ Starting deployment...${NC}"
            
            # Set deployment directory
            DEPLOY_DIR="$HOME/gov.intern"
            BACKUP_DIR="$HOME/gov.intern.backup.$(date +%Y%m%d_%H%M%S)"
            
            # Backup current version
            if [ -d "$DEPLOY_DIR" ]; then
              echo -e "${YELLOW}ðŸ“¦ Backing up current version...${NC}"
              cp -r "$DEPLOY_DIR" "$BACKUP_DIR"
            fi
            
            # Create deployment directory
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Extract new version
            echo -e "${YELLOW}ðŸ“‚ Extracting new version...${NC}"
            tar -xzf /tmp/deploy.tar.gz -C "$DEPLOY_DIR"
            rm /tmp/deploy.tar.gz
            
            # Create .env file from secrets
            echo -e "${YELLOW}âš™ï¸  Configuring environment...${NC}"
            cat > .env << 'ENVEOF'
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          NODE_ENV="production"
          NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}"
          SYNC_ENABLED="true"
          SYNC_CRON_SCHEDULE="0 2 * * *"
          DATA_GOV_API_BASE_URL="https://api.data.gov.in"
          DATA_GOV_API_KEY="${{ secrets.DATA_GOV_API_KEY }}"
          API_RATE_LIMIT_PER_MINUTE="100"
          ENVEOF
            
            # Stop existing containers
            echo -e "${YELLOW}â¸  Stopping existing containers...${NC}"
            docker-compose down || true
            
            # Build new images
            echo -e "${YELLOW}ðŸ”¨ Building Docker images...${NC}"
            docker-compose build --no-cache
            
            # Start services
            echo -e "${YELLOW}â–¶ï¸  Starting services...${NC}"
            docker-compose up -d
            
            # Wait for services to be ready
            echo -e "${YELLOW}â³ Waiting for services to be ready...${NC}"
            sleep 15
            
            # Check if PostgreSQL is ready
            MAX_TRIES=30
            TRIES=0
            until docker-compose exec -T postgres pg_isready -U mgnrega > /dev/null 2>&1 || [ $TRIES -eq $MAX_TRIES ]; do
              echo "Waiting for PostgreSQL... ($TRIES/$MAX_TRIES)"
              sleep 2
              TRIES=$((TRIES+1))
            done
            
            if [ $TRIES -eq $MAX_TRIES ]; then
              echo -e "âŒ PostgreSQL failed to start"
              # Rollback
              docker-compose down
              rm -rf "$DEPLOY_DIR"
              mv "$BACKUP_DIR" "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
              docker-compose up -d
              exit 1
            fi
            
            # Run migrations
            echo -e "${YELLOW}ðŸ—„ï¸  Running database migrations...${NC}"
            docker-compose exec -T app npx prisma migrate deploy
            docker-compose exec -T app npx prisma generate
            
            # Seed districts (if not already done)
            echo -e "${YELLOW}ðŸŒ± Seeding districts...${NC}"
            docker-compose exec -T app npx tsx scripts/seed-districts.ts || echo "Districts already seeded"
            
            # Health check
            echo -e "${YELLOW}ðŸ¥ Running health check...${NC}"
            sleep 5
            HEALTH_CHECK=$(curl -s http://localhost:3000/api/health || echo "failed")
            
            if echo "$HEALTH_CHECK" | grep -q "healthy"; then
              echo -e "${GREEN}âœ… Deployment successful!${NC}"
              # Clean up old backups (keep last 5)
              cd "$HOME"
              ls -t gov.intern.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -rf
            else
              echo -e "âŒ Health check failed. Rolling back..."
              docker-compose down
              rm -rf "$DEPLOY_DIR"
              mv "$BACKUP_DIR" "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
              docker-compose up -d
              exit 1
            fi
            
            echo -e "${GREEN}ðŸŽ‰ Deployment completed successfully!${NC}"
          EOF
      
      - name: Verify deployment
        run: |
          echo "Waiting for application to be fully ready..."
          sleep 10
          
          # Check health endpoint
          HEALTH=$(ssh -i ~/.ssh/azure_key ${{ secrets.AZURE_SSH_USER }}@${{ secrets.AZURE_VM_IP }} \
            "curl -s http://localhost:3000/api/health")
          
          if echo "$HEALTH" | grep -q "healthy"; then
            echo "âœ… Deployment verified successfully"
            echo "ðŸŒ Application is live at: http://${{ secrets.AZURE_VM_IP }}"
          else
            echo "âŒ Deployment verification failed"
            exit 1
          fi
      
      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful to Azure VM"
            echo "ðŸŒ URL: http://${{ secrets.AZURE_VM_IP }}"
            echo "ðŸ“ Commit: ${{ github.sha }}"
            echo "ðŸ‘¤ By: ${{ github.actor }}"
          else
            echo "âŒ Deployment failed"
            echo "ðŸ“ Commit: ${{ github.sha }}"
            echo "ðŸ‘¤ By: ${{ github.actor }}"
          fi

  # Job 3: Post-deployment tasks
  post-deploy:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_SSH_PRIVATE_KEY }}" > ~/.ssh/azure_key
          chmod 600 ~/.ssh/azure_key
          ssh-keyscan -H ${{ secrets.AZURE_VM_IP }} >> ~/.ssh/known_hosts
      
      - name: Sync real data (optional)
        if: github.ref == 'refs/heads/production'
        run: |
          echo "Triggering data sync..."
          ssh -i ~/.ssh/azure_key ${{ secrets.AZURE_SSH_USER }}@${{ secrets.AZURE_VM_IP }} \
            "curl -X POST http://localhost:3000/api/sync -H 'Content-Type: application/json' -d '{\"type\":\"current\",\"useMockData\":false}'" || true
      
      - name: Cleanup
        run: |
          rm -f ~/.ssh/azure_key

